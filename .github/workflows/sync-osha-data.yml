name: Sync OSHA Data

on:
  schedule:
    # Run inspection sync every 6 hours (4 times daily)
    # Times are in UTC: 00:00, 06:00, 12:00, 18:00
    - cron: '0 0,6,12,18 * * *'
  workflow_dispatch:
    inputs:
      sync_type:
        description: 'Type of sync to run'
        required: true
        default: 'both'
        type: choice
        options:
          - both
          - inspections
          - violations

env:
  # Your Vercel deployment URL
  API_BASE_URL: ${{ secrets.API_BASE_URL }}
  CRON_SECRET: ${{ secrets.CRON_SECRET }}

jobs:
  sync-inspections:
    name: Sync Inspections
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event.inputs.sync_type == 'both' || github.event.inputs.sync_type == 'inspections'

    steps:
      - name: Sync OSHA Inspections (Batch 1)
        run: |
          echo "Starting inspection sync batch 1..."
          response=$(curl -s -X POST "${{ env.API_BASE_URL }}/api/inspections/sync?days_back=30&max_requests=2" \
            -H "Content-Type: application/json" \
            -H "X-Cron-Secret: ${{ env.CRON_SECRET }}" \
            --max-time 30)
          echo "Response: $response"

          # Extract stats from response
          fetched=$(echo $response | jq -r '.fetched // 0')
          created=$(echo $response | jq -r '.created // 0')
          updated=$(echo $response | jq -r '.updated // 0')
          errors=$(echo $response | jq -r '.errors // 0')

          echo "Batch 1 complete: fetched=$fetched, created=$created, updated=$updated, errors=$errors"

      - name: Wait between batches
        run: sleep 5

      - name: Sync OSHA Inspections (Batch 2)
        run: |
          echo "Starting inspection sync batch 2..."
          response=$(curl -s -X POST "${{ env.API_BASE_URL }}/api/inspections/sync?days_back=30&max_requests=2" \
            -H "Content-Type: application/json" \
            -H "X-Cron-Secret: ${{ env.CRON_SECRET }}" \
            --max-time 30)
          echo "Response: $response"

          fetched=$(echo $response | jq -r '.fetched // 0')
          created=$(echo $response | jq -r '.created // 0')
          echo "Batch 2 complete: fetched=$fetched, created=$created"

      - name: Wait between batches
        run: sleep 5

      - name: Sync OSHA Inspections (Batch 3)
        run: |
          echo "Starting inspection sync batch 3..."
          response=$(curl -s -X POST "${{ env.API_BASE_URL }}/api/inspections/sync?days_back=30&max_requests=2" \
            -H "Content-Type: application/json" \
            -H "X-Cron-Secret: ${{ env.CRON_SECRET }}" \
            --max-time 30)
          echo "Response: $response"

          fetched=$(echo $response | jq -r '.fetched // 0')
          created=$(echo $response | jq -r '.created // 0')
          echo "Batch 3 complete: fetched=$fetched, created=$created"

  sync-violations:
    name: Sync Violations
    runs-on: ubuntu-latest
    needs: sync-inspections
    if: always() && (github.event_name == 'schedule' || github.event.inputs.sync_type == 'both' || github.event.inputs.sync_type == 'violations')

    steps:
      - name: Sync Violations (Batch 1)
        run: |
          echo "Starting violation sync batch 1..."
          response=$(curl -s -X POST "${{ env.API_BASE_URL }}/api/inspections/sync/violations?max_inspections=5" \
            -H "Content-Type: application/json" \
            -H "X-Cron-Secret: ${{ env.CRON_SECRET }}" \
            --max-time 30)
          echo "Response: $response"

          checked=$(echo $response | jq -r '.inspections_checked // 0')
          new_violations=$(echo $response | jq -r '.new_violations_found // 0')
          echo "Batch 1 complete: checked=$checked, new_violations=$new_violations"

      - name: Wait between batches
        run: sleep 5

      - name: Sync Violations (Batch 2)
        run: |
          echo "Starting violation sync batch 2..."
          response=$(curl -s -X POST "${{ env.API_BASE_URL }}/api/inspections/sync/violations?max_inspections=5" \
            -H "Content-Type: application/json" \
            -H "X-Cron-Secret: ${{ env.CRON_SECRET }}" \
            --max-time 30)
          echo "Response: $response"

          checked=$(echo $response | jq -r '.inspections_checked // 0')
          new_violations=$(echo $response | jq -r '.new_violations_found // 0')
          echo "Batch 2 complete: checked=$checked, new_violations=$new_violations"

      - name: Wait between batches
        run: sleep 5

      - name: Sync Violations (Batch 3)
        run: |
          echo "Starting violation sync batch 3..."
          response=$(curl -s -X POST "${{ env.API_BASE_URL }}/api/inspections/sync/violations?max_inspections=5" \
            -H "Content-Type: application/json" \
            -H "X-Cron-Secret: ${{ env.CRON_SECRET }}" \
            --max-time 30)
          echo "Response: $response"

          checked=$(echo $response | jq -r '.inspections_checked // 0')
          new_violations=$(echo $response | jq -r '.new_violations_found // 0')
          echo "Batch 3 complete: checked=$checked, new_violations=$new_violations"

  summary:
    name: Sync Summary
    runs-on: ubuntu-latest
    needs: [sync-inspections, sync-violations]
    if: always()

    steps:
      - name: Print Summary
        run: |
          echo "========================================"
          echo "OSHA Data Sync Complete"
          echo "========================================"
          echo "Inspection sync: ${{ needs.sync-inspections.result }}"
          echo "Violation sync: ${{ needs.sync-violations.result }}"
          echo "========================================"
